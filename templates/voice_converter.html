{% extends "base.html" %}

{% block title %}Voice-Sign & Sign-Voice Converter | HandSignify{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='sign_generator.css') }}">
{% endblock %}

{% block content %}
<main class="generator-feature">
    <div class="generator-card">
        <div class="generator-header">
            <h2>Voice-Sign & Sign-Voice Converter</h2>
            <p>Convert between voice and sign language in both directions.</p>
        </div>

        <!-- Feature Toggle Navigation -->
        <div class="tab-navigation">
            <button class="tab-button active" data-tab="voiceToSignPanel">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path>
                    <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
                    <line x1="12" y1="19" x2="12" y2="23"></line>
                    <line x1="8" y1="23" x2="16" y2="23"></line>
                </svg>
                Voice → Sign
            </button>
            <button class="tab-button" data-tab="signToVoicePanel">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
                    <path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path>
                </svg>
                Sign → Voice
            </button>
        </div>

        <!-- Voice → Sign Panel -->
        <div id="voiceToSignPanel" class="tab-content active">
            <div class="feature-panel">
                <h3>Voice → Sign: Speech to Signs</h3>
                <p class="text-muted mb-4">Speak into your microphone and see the corresponding sign language
                    alphabet.</p>

                <!-- Browser Compatibility Warning -->
                <div id="browserWarning" class="alert alert-warning hidden">
                    Speech recognition not supported in this browser. Please use Chrome or Edge.
                </div>

                <!-- Microphone UI -->
                <div class="microphone-section">
                    <div id="microphoneButton" class="microphone-button">
                        <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path>
                            <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
                            <line x1="12" y1="19" x2="12" y2="23"></line>
                            <line x1="8" y1="23" x2="16" y2="23"></line>
                        </svg>
                    </div>

                    <!-- Listening Indicator -->
                    <div id="listeningIndicator" class="listening-indicator hidden">
                        <span>Listening</span>
                        <div class="dots">
                            <span>.</span><span>.</span><span>.</span>
                        </div>
                    </div>

                    <!-- Control Buttons -->
                    <div class="voice-controls">
                        <button type="button" id="startListeningBtn" class="btn-generate">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <circle cx="12" cy="12" r="10"></circle>
                                <polygon points="10 8 16 12 10 16 10 8"></polygon>
                            </svg>
                            <span>Start Listening</span>
                        </button>
                        <button type="button" id="stopListeningBtn" class="btn-outline hidden">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <circle cx="12" cy="12" r="10"></circle>
                                <rect x="9" y="9" width="6" height="6"></rect>
                            </svg>
                            <span>Stop Listening</span>
                        </button>
                    </div>
                </div>

                <!-- Transcript Display -->
                <div id="transcriptSection" class="transcript-section hidden">
                    <label>Recognized Text:</label>
                    <div id="transcriptDisplay" class="transcript-display"></div>
                </div>

                <!-- Error Message (Voice-specific) -->
                <div id="voiceErrorMessage" class="alert alert-danger mt-4 hidden"></div>

                <!-- Sign Output Container -->
                <div id="voiceSignOutput" class="sign-output-container hidden"></div>
            </div>
        </div>

        <!-- Sign → Voice Panel (NEW FEATURE) -->
        <div id="signToVoicePanel" class="tab-content">
            <div class="feature-panel">
                <h3>Sign → Voice: Signs to Speech</h3>
                <p class="text-muted mb-4">Use your camera to show signs, and the system will speak the recognized
                    text.</p>

                <div class="controls mb-3">
                    <button id="startCameraButtonVoice" class="btn-primary">Start Camera</button>
                    <button id="closeCameraButtonVoice" class="btn-danger-custom hidden">Stop Camera</button>
                </div>

                <!-- Camera Feed Container -->
                <div id="cameraFeedContainerVoice" class="camera-feed-box hidden">
                    <img id="cameraFeedVoice" src="" alt="Camera Stream">
                </div>

                <!-- Prediction Display & Speech Controls -->
                <div id="predictionSection" class="transcript-section mt-4 hidden">
                    <label>Detected Sign:</label>
                    <div id="predictionDisplay" class="transcript-display"></div>

                    <div class="voice-controls mt-3">
                        <button id="speakPredictionBtn" class="btn-generate">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
                                <path d="M19.07 4.93a10 10 0 0 1 0 14.14"></path>
                            </svg>
                            <span>Speak</span>
                        </button>

                        <!-- Advanced Speech Controls (Optional) -->
                        <button id="toggleSpeechControlsBtn" class="btn-outline">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <circle cx="12" cy="12" r="3"></circle>
                                <path
                                    d="M12 1v6m0 6v6M5.64 5.64l4.24 4.24m4.24 4.24l4.24 4.24M1 12h6m6 0h6M5.64 18.36l4.24-4.24m4.24-4.24l4.24-4.24">
                                </path>
                            </svg>
                            <span>Voice Settings</span>
                        </button>
                    </div>

                    <!-- Optional Advanced Controls -->
                    <div id="advancedSpeechControls" class="mt-3 hidden">
                        <div class="row">
                            <div class="col-md-6 mb-2">
                                <label for="speechRate" class="form-label">Speed: <span
                                        id="rateValue">1.0</span>x</label>
                                <input type="range" id="speechRate" class="form-range" min="0.5" max="2" step="0.1"
                                    value="1.0">
                            </div>
                            <div class="col-md-6 mb-2">
                                <label for="speechPitch" class="form-label">Pitch: <span
                                        id="pitchValue">1.0</span></label>
                                <input type="range" id="speechPitch" class="form-range" min="0.5" max="2" step="0.1"
                                    value="1.0">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Real-time Prediction Display -->
                <div id="predictionTextSection" class="mt-4 hidden">
                    <label><strong>Detected Signs:</strong></label>
                    <div id="predictionOutput" class="prediction-text-display"></div>
                    <div class="d-flex gap-2 mt-2">
                        <button id="clearPredictionsBtn" class="btn-outline">Clear Text</button>
                        <button id="speakAllBtn" class="btn-generate">Speak All</button>
                    </div>
                </div>

                <div class="info-box mt-4">
                    <p class="mb-0"><strong>Tip:</strong> The system will detect signs and store the most recent
                        prediction. Click "Speak" to hear it pronounced.</p>
                </div>
            </div>
        </div>

    </div>
</main>

<!-- Socket.IO Client -->
<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='camera-controller.js') }}"></script>
<script src="{{ url_for('static', filename='feature-utils.js') }}"></script>
<script src="{{ url_for('static', filename='realtime-interaction.js') }}"></script>
<script src="{{ url_for('static', filename='voice-sign.js') }}"></script>
<!-- Note: sign-voice.js removed as it might be redundant or integrated into realtime-interaction.js logic? 
     Wait, sign-voice.js from original file seemed to handle speech synthesis controller. 
     I should verify if I covered everything in realtime-interaction.js or if I need sign-voice.js still.
     The user audit said "Extract shared logic". 
     Let's keep sign-voice.js if it contains unique logic not yet migrated, OR since I implemented initWebSocket and speakText, 
     I might have covered the core parts. 
     However, voice-sign.js handles the Microphone logic (Voice -> Sign). I did not touch that in realtime-interaction.js. 
     So voice-sign.js MUST stay. 
     sign-voice.js handles the Text-to-Speech controller logic.
     My realtime-interaction.js has speakText(). 
     Let's replicate the main glue code here to bind everything together. -->

<script>
    // Glue code to initialize modules
    let cameraControllerVoice = null;

    document.addEventListener('DOMContentLoaded', function () {
        // Setup feature toggle
        setupFeatureToggle('.tab-button', '.tab-content', {
            onSwitch: (targetPanel) => {
                // Stop cameras when switching panels
                if (targetPanel === 'voiceToSignPanel') {
                    if (cameraControllerVoice) {
                        cameraControllerVoice.stopCamera();
                        disconnectWebSocket(); // Stop WS when leaving Sign->Voice
                    }
                }
            }
        });

        // Initialize Sign → Voice (Camera + WebSocket)
        initSignToVoice();
    });

    function initSignToVoice() {
        // Initialize camera
        cameraControllerVoice = initCameraController({
            startButtonId: 'startCameraButtonVoice',
            stopButtonId: 'closeCameraButtonVoice',
            feedElementId: 'cameraFeedVoice',
            containerId: 'cameraFeedContainerVoice',
            videoFeedUrl: "{{ url_for('video_feed') }}",
            onPrediction: null // We use WebSocket for predictions
        });

        // Toggle Speech Controls
        const toggleBtn = document.getElementById('toggleSpeechControlsBtn');
        const advancedControls = document.getElementById('advancedSpeechControls');
        if (toggleBtn && advancedControls) {
            toggleBtn.addEventListener('click', () => advancedControls.classList.toggle('hidden'));
        }

        // Live Rate/Pitch value updates
        ['speechRate', 'speechPitch'].forEach(id => {
            const input = document.getElementById(id);
            const display = document.getElementById(id === 'speechRate' ? 'rateValue' : 'pitchValue');
            if (input && display) {
                input.addEventListener('input', (e) => display.textContent = e.target.value);
            }
        });

        // Camera Start/Stop hooks for WebSocket
        const startBtn = document.getElementById('startCameraButtonVoice');
        const stopBtn = document.getElementById('closeCameraButtonVoice');

        if (startBtn) {
            startBtn.addEventListener('click', () => {
                console.log('Starting WebSocket...');
                initWebSocket({
                    onPrediction: (char) => {
                        const display = document.getElementById('predictionDisplay');
                        if (display) {
                            display.textContent = char;
                            document.getElementById('predictionSection').classList.remove('hidden');
                        }
                    },
                    onStablePrediction: (char, fullText) => {
                        const output = document.getElementById('predictionOutput');
                        if (output) {
                            output.textContent = fullText;
                            document.getElementById('predictionTextSection').classList.remove('hidden');
                        }
                    }
                });
            });
        }

        if (stopBtn) {
            stopBtn.addEventListener('click', () => {
                disconnectWebSocket();
            });
        }

        // Speak Button
        document.getElementById('speakPredictionBtn')?.addEventListener('click', () => {
            const text = document.getElementById('predictionDisplay')?.textContent;
            if (text) speakText(text);
        });

        // Speak All Button
        document.getElementById('speakAllBtn')?.addEventListener('click', () => {
            const text = document.getElementById('predictionOutput')?.textContent;
            if (text) speakText(text);
        });

        // Clear Button
        document.getElementById('clearPredictionsBtn')?.addEventListener('click', () => {
            clearAccumulatedText(); // from realtime-interaction.js
            const output = document.getElementById('predictionOutput');
            if (output) output.textContent = '';
        });
    }
</script>
{% endblock %}